<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bills History</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">Order Management</div>
        <div class="nav-right">
            <span id="userInfo"></span>
            <button onclick="logout()" class="btn-logout">Logout</button>
        </div>
    </nav>

    <div class="main-wrapper">
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="dashboard.html">ğŸ“Š Dashboard</a></li>
                <li><a href="orders.html">ğŸ“¦ Orders</a></li>
                <li><a href="products.html">ğŸ›ï¸ Products</a></li>
                <li><a href="billing.html">ğŸ’° Billing</a></li>
                <li><a href="bills.html" class="active">ğŸ“„ Bills History</a></li>
                <li><a href="dispatched.html">ğŸ“¤ Dispatched</a></li>
                <li><a href="employees.html">ğŸ‘¥ Employee Management</a></li>
                <li><a href="automation.html">âš¡ Automation</a></li>
                <li><a href="return-scan.html">ğŸ“· Return Scan</a></li>
                <li><a href="backup.html">ğŸ’¾ Backup & Restore</a></li>
                <li><a href="sellers.html" id="sellersLink" style="display: none;">ğŸ‘¥ Sellers</a></li>
            </ul>
        </aside>

        <div class="container">
            <div class="page-header">
                <h1 style="color: #ff8c00;">Bills History</h1>
                <div class="header-actions" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <select id="sellerFilter" onchange="loadBills()" style="padding: 10px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="">All Sellers</option>
                    </select>
                    <button onclick="downloadAllBillsExcel()" class="btn-primary" style="padding: 10px 15px; font-size: 13px; background: #27ae60;">
                        ğŸ“Š Export All Excel
                    </button>
                </div>
            </div>

            <!-- Tabs for Search and Bill Matching -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; border-bottom: 2px solid #e0e0e0;">
                    <button id="searchTab" onclick="switchTab('search')" class="tab-button active" style="padding: 12px 20px; background: white; color: #000; border: 2px solid #000; border-radius: 5px 5px 0 0; cursor: pointer; font-weight: bold;">
                        ğŸ” Search Orders
                    </button>
                    <button id="matchingTab" onclick="switchTab('matching')" class="tab-button" style="padding: 12px 20px; background: white; color: #000; border: 2px solid #000; border-radius: 5px 5px 0 0; cursor: pointer; font-weight: bold;">
                        âœ… Bill Matching
                    </button>
                </div>
            </div>

            <!-- Search Section -->
            <div id="searchSection" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e0e0e0;">
                <h3 style="margin-top: 0; color: #ff8c00;">Search Orders in Bills</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #000;">Tracking ID</label>
                        <input type="text" id="searchTrackingId" placeholder="Enter Tracking ID" 
                               style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 14px;"
                               onkeypress="if(event.key === 'Enter') searchInBills()">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #000;">Order Number (Reference)</label>
                        <input type="text" id="searchOrderNumber" placeholder="Enter Order Number" 
                               style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 14px;"
                               onkeypress="if(event.key === 'Enter') searchInBills()">
                    </div>
                    <div>
                        <button onclick="searchInBills()" class="btn-primary" style="width: 100%; padding: 12px; font-size: 14px; font-weight: bold;">ğŸ” Search</button>
                    </div>
                    <div>
                        <button onclick="clearSearch()" class="btn-secondary" style="width: 100%; padding: 12px; font-size: 14px;">Clear Search</button>
                    </div>
                </div>
                <div id="searchResults" style="margin-top: 15px; display: none;"></div>
            </div>

            <!-- Bill Matching Section -->
            <div id="matchingSection" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e0e0e0; display: none;">
                <h3 style="margin-top: 0; color: #ff8c00;">Bill Matching - Match Reference Numbers with Bills</h3>
                <p style="color: #000; margin-bottom: 15px;">Upload Excel file with Reference Number, Profit, and Status columns to match with existing bills.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #000;">Seller *</label>
                        <select id="matchingSellerFilter" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 14px;">
                            <option value="">Select Seller</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 5px; border: 2px solid #e0e0e0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #000;">ğŸ“ Upload Excel File *</label>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" 
                           style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 14px; margin-bottom: 10px;"
                           onchange="handleExcelUpload(event)">
                    <small style="color: #000; display: block; margin-top: 5px;">
                        Excel format with columns: <strong>Reference Number</strong> (or Order Number), <strong>Profit</strong>, <strong>Status</strong> (delivered/return/pending)
                    </small>
                    <button onclick="downloadMatchingTemplate()" class="btn-secondary" style="margin-top: 10px; padding: 8px 15px; font-size: 12px;">ğŸ“¥ Download Template</button>
                </div>

                <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 5px; border: 2px solid #000;">
                    <strong style="color: #000;">OR Enter Manually:</strong>
                    <textarea id="referenceNumbersInput" placeholder="Enter reference numbers with profit and status. Format:&#10;ORD001,500.50,delivered&#10;ORD002,750.25,return&#10;ORD003,300.00,pending" 
                              style="width: 100%; min-height: 100px; padding: 10px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 14px; font-family: monospace; margin-top: 10px;"></textarea>
                    <small style="color: #000; display: block; margin-top: 5px;">Format: ReferenceNumber,Profit,Status (one per line)</small>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="matchBills()" class="btn-primary" style="padding: 12px 30px; font-size: 14px; font-weight: bold;">ğŸ” Match Bills</button>
                    <button onclick="clearMatching()" class="btn-secondary" style="padding: 12px 30px; font-size: 14px;">Clear</button>
                </div>

                <div id="matchingResults" style="margin-top: 20px; display: none;"></div>
            </div>

            <div class="table-container">
                <table id="billsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Bill Number</th>
                            <th>Seller Name</th>
                            <th>Customer Name</th>
                            <th>Total Orders</th>
                            <th>Delivered</th>
                            <th>Returns</th>
                            <th>Total Profit</th>
                            <th>Total DC</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="billsTableBody">
                        <tr>
                            <td colspan="11" class="loading">Loading bills...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bill Detail Modal -->
    <div id="billDetailModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeBillDetailModal()">&times;</span>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                <h2 id="billDetailTitle" style="color: #ff8c00; margin: 0;">Bill Details</h2>
                <div id="billDownloadButtons" style="display: flex; gap: 10px;">
                    <button onclick="downloadBillPDF()" class="btn-primary" style="padding: 8px 15px; font-size: 14px; background: #e74c3c;">
                        ğŸ“„ Download PDF
                    </button>
                    <button onclick="downloadBillExcel()" class="btn-primary" style="padding: 8px 15px; font-size: 14px; background: #27ae60;">
                        ğŸ“Š Download Excel
                    </button>
                </div>
            </div>
            <div id="billDetailContent"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="mobile-menu.js"></script>
    <script src="bills.js"></script>
    <script>
        // Show sellers link for admin
        window.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const sellersLink = document.getElementById('sellersLink');
            if (sellersLink && user.role === 'admin') {
                sellersLink.style.display = 'block';
            }
        });
    </script>
</body>
</html>

